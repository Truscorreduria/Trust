{% extends 'adminlte/index.html' %}
{% load crispy_forms_filters static %}


{% block style %}
    <link rel="stylesheet" href="{% static 'adminlte/plugins/bootstrap-select/dist/css/bootstrap-select.min.css' %}">
{% endblock %}


{% block content %}
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <form action="." id="form-report" method="post" data-filename="{{ filename }}">
                    {% csrf_token %}
                    {{ form|crispy }}
                    <div class="row">
                        <button type="submit" class="btn btn-info">Generar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

{% endblock %}


{% block javascript %}
    <script src="{% static 'adminlte/plugins/bootstrap-select/dist/js/bootstrap-select.min.js' %}"></script>
    <script src="{% static 'js-xlsx/dist/xlsx.full.min.js' %}"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $('.dateinput').datepicker({
                dateFormat: 'dd/mm/yy',
            });


            $(document).on('submit', 'form', function (event) {
                event.preventDefault();
                const _this = $(this);
                const data = new FormData(this);
                $.ajax(_this.attr('action'), {
                    method: "post",
                    data: data,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        console.log(response);
                        const book = XLSX.utils.book_new();
                        const sheet = XLSX.utils.json_to_sheet(response.raw_data);
                        XLSX.utils.book_append_sheet(book, sheet, event.target.value);
                        XLSX.writeFile(book, _this.data('filename'));
                    }
                })
            })
        })
    </script>
{% endblock %}