{% extends 'trustseguros/lte/index.html' %}
{% load static datatables %}


{% block style %}
    <link rel="stylesheet" href="{% static 'trustseguros/lte/plugins/datatables-bs4/css/dataTables.bootstrap4.css' %}">
    <link rel="stylesheet" href="{% static 'izimodal/css/iziModal.min.css' %}">
    <link rel="stylesheet" href="{% static 'trustseguros/lte/css/datatables.trust.css' %}">
    <link rel="stylesheet" href="{% static 'trustseguros/lte/css/buttons.css' %}">
    <link rel="stylesheet" href="{% static 'bootstrap-select/dist/css/bootstrap-select.min.css' %}">
    {% for link in media.css %}
        <link rel="stylesheet" href="{% static link %}">
    {% endfor %}
{% endblock %}


{% block content-title %}
    {{ opts.verbose_name_plural|capfirst }}
{% endblock %}


{% block breadcrums %}
    <ol class="breadcrumb float-sm-right">
        <li class="breadcrumb-item"><a href="{% url 'trustseguros:index' %}">Inicio</a></li>
        <li class="breadcrumb-item active">{{ opts.verbose_name_plural|capfirst }}</li>
    </ol>
{% endblock %}


{% block content %}
    <table id="{{ opts.model_name }}-table" class="table table-bordered table-hover">

    </table>

    {% include form_template %}
{% endblock %}


{% block javascript %}

    <script type="text/javascript">
        const $ajax_getCollection = "{% url 'ajax_getCollection' %}";
    </script>

    <script src="{% static 'trustseguros/lte/plugins/datatables/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'trustseguros/lte/plugins/datatables-bs4/js/dataTables.bootstrap4.js' %}"></script>
    <script src="{% static 'trustseguros/lte/plugins/datatables-buttons/js/dataTables.buttons.min.js' %}"></script>
    <script src="{% static 'trustseguros/lte/js/datatables.ES_NI.js' %}"></script>
    <script src="{% static 'izimodal/js/iziModal.min.js' %}"></script>
    <script src="{% static 'sweetalert2/dist/sweetalert2.min.js' %}"></script>
    <script src="{% static 'growl/javascripts/jquery.growl.js' %}"></script>
    <script src="{% static 'bootstrap-select/dist/js/bootstrap-select.min.js' %}"></script>
    <script src="{% static 'ajax/token.js' %}"></script>
    <script type="text/javascript">

        function li_errors(errors) {
            let li = ``;
            $.each(errors, function (i, error) {
                li += `<li>${error.message}</li>`
            });
            return li;
        }

        const modal_width = parseInt('{{ modal_width }}');

        const form_submit = function (e) {
            e.preventDefault();
            //$('.table-template').remove();
            const data = new FormData(this);
            const _this = $(this);
            data.append('save', 'save');
            $.ajax(_this.attr('action'), {
                method: _this.data('method'),
                data: data,
                processData: false,
                contentType: false,
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        modal.iziModal('close');
                        update_table(response)
                    } else {
                        modal.iziModal('destroy');
                        modal.empty().append(response.form);
                        modal.iziModal({
                            title: "{{ verbose_name|capfirst }}",
                            subtitle: 'Información general del {{ verbose_name }}',
                            width: modal_width, padding: 20, fullscreen: false, zindex: 1500,
                            headerColor: '#222d32'
                        }).iziModal('open');
                    }
                    if (response.instance) {
                        $('input[name="id"]').val(response.instance.id);
                    }

                    {% comment %}$('.dateinput').datepicker({
                        autoclose: true,
                        format: 'dd/mm/yyyy',
                    });{% endcomment %}

                    $.each(response.errors, function (n, error) {
                        $.growl.error({
                            message: `<p>${error.key}</p>
                                                 <ul>${li_errors(error.errors)}</ul>`
                        });
                    });
                },
                error: function (error) {
                    console.log(error);
                }
            })
        };

        const new_object = function (e, dt, node, config) {
            $.ajax(".", {
                method: 'PUT',
                data: {open: 'open'},
                success: function (response, resonse_status, xhr) {
                    modal.iziModal('destroy');
                    modal.empty().append(response.form);
                    modal.iziModal({
                        title: 'Agregar {{ verbose_name }}',
                        subtitle: 'Información general del {{ verbose_name }}',
                        width: modal_width, padding: 20, fullscreen: false, zindex: 1500,
                        headerColor: '#326634'
                    }).iziModal('open');

                    $('form').data('method', 'put');

                    $('input[name="id"]').val('');

                    $('.dateinput').datepicker({
                        autoclose: true,
                        format: 'dd/mm/yyyy',
                    });
                    $('.selectpicker').selectpicker();
                }
            });
        };

        const table = $('#{{ opts.model_name }}-table').DataTable({
            dom: 'Bfrtip',
            language: ES_ni,
            processing: true,
            serverSide: true,
            ajax: {
                url: ".",
                type: 'POST',
                data: {'list': 'list'}
            },
            columns: [
                {% for field in list_display %}
                    {{ form|datatables_column:field }}
                {% endfor %}
            ],
            buttons: [
                {
                    text: '<i class="fas fa-plus"></i> Agregar {{ opts.verbose_name }}',
                    action: new_object,
                    className: 'btn btn-trust'
                },
            ]

        });

        const modal = $('#{{ opts.model_name }}-modal').iziModal({});

        const show_object = function () {
            const obj = table.row(this).data();
            $.ajax('.', {
                method: "POST",
                data: {id: obj.id, 'open': 'open'},
                success: function (response, respose_text, xhr) {
                    modal.iziModal('destroy');
                    modal.empty().append(response.form);
                    modal.iziModal({
                        title: "{{ opts.verbose_name|capfirst }}",
                        subtitle: 'Información general del {{ opts.verbose_name }}',
                        width: modal_width, padding: 20, fullscreen: false, zindex: 1500,
                        headerColor: '#326634'
                    }).iziModal('open');

                    $('input[name="id"]').val(obj.id);

                    //$('.dateinput').datetimepicker();
                    $('.selectpicker').selectpicker();

                    $('form').data('method', 'post');
                }
            });
        };

        const update_table = function (response) {
            if (response.instance) {
                try {
                    table.row("#" + response.instance.id).data(response.instance).draw(false);
                }
                catch (error) {
                    table.row.add(response.instance).draw(false);
                }
            }
        };

        const add_row = function () {
            const _this = $(this);
            const $template = $('#' + _this.data('template'));
            const $target = $('#' + _this.data('target'));
            const row = $($template.find('tr')[0]).clone();
            $target.append(row);

            $('.dateinput').datepicker({
                autoclose: true,
                format: 'dd/mm/yyyy',
            });
        };

        $(document).ready(function () {
            $(document)
                .ajaxStart(function () {
                    startLoader()
                })
                .ajaxStop(function () {
                    stopLoader()
                });


            $('#{{ opts.model_name }}-table').on('click', 'tbody tr', show_object);

            $(document).on('submit', '#{{ opts.model_name }}-form', form_submit);

            $(document).on('click', '#btn-save', function () {
                $('#{{ opts.model_name }}-form').trigger('submit')
            });

        });

    </script>

    {% for script in media.js %}
        <script src="{% static script %}"></script>
    {% endfor %}
{% endblock %}