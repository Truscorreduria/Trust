{% extends 'adminlte/datatables.html' %}
{% load static datatables %}

{% block content %}
    {{ block.super }}

    <div id="modal-cuota">
        <div class="container"></div>
    </div>
{% endblock %}


{% block javascript %}

    {{ block.super }}
    <script type="text/javascript">

        $(document).ready(function () {


            const $modalcuota = $('#modal-cuota').iziModal({
                zindex: 2500,
                width: 1200,
                title: 'prueba',
                subtitle: 'prueba',
                headerColor: "#326634",
                onClosed: function () {
                    modal.iziModal('open')
                }
            });


            $('.dt-buttons').css({
                display: 'none'
            });

            $(document).on('change', '#id_recibos', function () {
                $('#id_recibo_editar').val($(this).val());
                const form = $('#{{ opts.model_name }}-form');
                const data = new FormData(form[0]);
                perform_action(data, 'POST', '.', 'cambiar_recibo')
            });

            const calcular_prima_neta = function () {
                let prima = parseFloat($('#id_subtotal').val());
                let descuento = parseFloat($('#id_descuento').val());
                $('#id_prima_neta').val((prima - descuento).toFixed(2))
                    .trigger('change')
            };

            const calcular_total = function () {
                let prima_neta = parseFloat($('#id_prima_neta').val());
                let emision = parseFloat($('#id_emision').val());
                let iva = parseFloat($('#id_iva').val());
                let otros = parseFloat($('#id_otros').val());
                $('#id_total').val((prima_neta + emision + iva + otros).toFixed(2)).trigger('change')
            };

            const calcular_comision = function () {
                let prima_neta = parseFloat($('#id_prima_neta').val());
                let per_comision = parseFloat($('#id_per_comision').val());
                $('#id_amount_comision').val(((prima_neta * per_comision) / 100).toFixed(2))
            };

            const calcular_tabla_pagos = function () {
                const form = $('#poliza-form')[0];
                const data = new FormData(form);
                data.append('calcular_tabla_pagos', 'calcular_tabla_pagos');
                $.ajax(".", {
                    method: "POST",
                    data: data,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        const pagos = $('#id_tabla_pagos tbody').empty();
                        $.each(response, function (i, o) {
                            pagos.append(`
                                    <tr>
                                        <td>
                                            <input type="hidden" name="tabla_pagos_id">
                                            <input type="text" name="tabla_pagos_numero" class="form-control" readonly value="${o.numero}">
                                        </td>
                                        <td>
                                            <input type="text" name="tabla_pagos_fecha_vence" class="form-control" readonly value="${o.fecha}">
                                        </td>
                                        <td>
                                            <input type="text" name="tabla_pagos_monto" class="form-control" value="${o.monto}">
                                        </td>
                                        <td>
                                            <input type="text" name="tabla_pagos_monto_comision" class="form-control" value="${o.monto_comision}">
                                        </td>
                                        <td>
                                            <input type="text" name="tabla_pagos_estado" class="form-control" readonly value="${o.estado}">
                                        </td>
                                    </tr>
                            `)
                        });
                        let total_pagos = 0.0;
                        $.each($('input[name="tabla_pagos_monto"]'), function (i, o) {
                            total_pagos += parseFloat($(o).val())
                        });
                        $('#id_total_pagos').val(total_pagos);
                    }
                })
            };

            $(document).on('change', 'input[name="tabla_pagos_monto"]', function () {
                let total_pagos = 0.0;
                $.each($('input[name="tabla_pagos_monto"]'), function (i, o) {
                    total_pagos += parseFloat($(o).val())
                });
                $('#id_total_pagos').val(total_pagos);
            });

            $(document).on('change', '#id_subtotal', calcular_prima_neta);
            $(document).on('change', '#id_descuento', calcular_prima_neta);

            $(document).on('change', '#id_prima_neta', calcular_total);
            $(document).on('change', '#id_emision', calcular_total);
            $(document).on('change', '#id_iva', calcular_total);
            $(document).on('change', '#id_otros', calcular_total);

            $(document).on('change', '#id_prima_neta', calcular_comision);
            $(document).on('change', '#id_per_comision', calcular_comision);

            $(document).on('change', '#id_cuotas', calcular_tabla_pagos);
            $(document).on('change', '#id_fecha_pago', calcular_tabla_pagos);
            $(document).on('change', '#id_total', calcular_tabla_pagos);
            $(document).on('change', '#id_per_comision', calcular_tabla_pagos);

            $(document).on('change', '#id_f_pago', function () {
                if ($(this).val() === "1") {
                    $('#id_cuotas').attr('readonly', 'readonly').val('1').trigger('change')
                } else {
                    $('#id_cuotas').removeAttr('readonly')
                }
            });
            $(document).on('click', '#btn-ecuenta', function () {
                const _this = $(this);
                $.ajax('.', {
                    method: "POST",
                    data: {
                        id: $('input[name="id"]').val(),
                        estado_cuenta: 'estado_cuenta'
                    },
                    success: function (response) {
                        let blob = new Blob([response], {type: 'application/pdf'});
                        let link = document.createElement('a');
                        link.href = window.URL.createObjectURL(blob);
                        link.download = "Estado de cuenta.pdf";
                        link.click();
                        _this.removeAttr('disabled')
                    }
                })
            });
            $(document).on('click', '#btn-null', function () {
                swal({
                    title: 'Estas seguro?',
                    text: "Esta acción no se puede revertir!",
                    imageUrl: "{% static 'cotizador/images/trusty/pregunta.png' %}",
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Si, anúlalo!',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.value) {
                        swal(
                            'Recibo anulado con éxito!',
                            'Todas las operaciones relacionadas se realizaron correctamente.',
                            'success'
                        ).then(() => {
                            const form = $('#{{ opts.model_name }}-form');
                            const data = new FormData(form[0]);
                            perform_action(data, 'POST', '.', 'anular_recibo')
                        })
                    }
                })

            });

            $(document).on('click', '.btn-edit-cuota', function () {
                const _this = $(this);
                $.ajax('.', {
                    method: "POST",
                    data: {
                        cuota: _this.data('cuota'),
                        opencuota: 'opencuota'
                    },
                    success: function (response) {
                        $modalcuota.iziModal('destroy');
                        $modalcuota.iziModal({
                            zindex: 2500,
                            width: 1200,
                            title: response.instance.str,
                            subtitle: 'datos de la cuota',
                            headerColor: "#326634",
                            onClosed: function () {
                                modal.iziModal('open')
                            }
                        });
                        const content = $modalcuota.find('.container');
                        $(content).html(response.html);
                        $modalcuota.iziModal('open')
                    }
                });
            });

            $modalcuota.on('')

        });

    </script>
{% endblock %}