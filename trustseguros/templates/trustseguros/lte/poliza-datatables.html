{% extends 'trustseguros/lte/datatables.html' %}
{% load static datatables %}


{% block javascript %}

    {{ block.super }}
    <script type="text/javascript">

        $(document).ready(function () {

            function coberturaTemplate(cobertura) {
                return (`<tr>
                            <td>
                                <input type="checkbox" name="cobertura-select">
                            </td>
                            <td>
                                ${cobertura.name}
                                <input type="hidden" name="cobertura" value="${cobertura.id}">
                            </td>
                            <td>
                                <input type="number" class="form-control" value="0.0" name="monto"
                                style="max-width: 150px">
                            </td>
                        </tr>`)
            }

            $(document).on('change', '#id_ramo', function () {
                const _this = $(this);
                $.ajax("{% url 'ajax_getCollection' %}", {
                    method: 'POST',
                    data: {
                        app_label: 'cotizador', model: 'subramo',
                        filters: `{'ramo_id': '${_this.val()}'}`
                    },
                    success: function (response) {
                        const table = $('#id_sub_ramo').empty();
                        table.append(`<option value="">---------</option>`);
                        $.each(response, function (i, o) {
                            table.append(`<option value="${o.id}">${o.name}</option>`);
                        })
                    }
                })
            });

            $(document).on('change', '#id_sub_ramo', function () {
                const _this = $(this);
                $.ajax("{% url 'ajax_getCollection' %}", {
                    method: 'POST',
                    data: {
                        app_label: 'cotizador', model: 'cobertura',
                        filters: `{'sub_ramo_id': '${_this.val()}'}`
                    },
                    success: function (response) {
                        const table = $('#coberturas-table tbody').empty();
                        $.each(response, function (i, o) {
                            table.append(coberturaTemplate(o));
                        })
                    }
                })
            });

            $(document).on('change', '#id_ramo', function () {
                const _this = $(this);
                const $fieldset = $('.extra_data_fieldset').empty();
                $.ajax("{% url 'ajax_getCollection' %}", {
                    method: "POST",
                    data: {
                        app_label: 'cotizador', model: 'campoadicional',
                        filters: `{'ramo_id': ${_this.val()}}`
                    },
                    success: function (response) {
                        $.each(response, function (i, o) {
                            $fieldset.append(`
                            <div class="col-md-3">
                                <div id="div_${o.name}" class="form-group">

                                    <label for="id_${o.name}" class="col-form-label">
                                        ${o.label}
                                    </label>

                                    <input name="${o.name}" class="form-control" id="id_${o.name}">

                                </div>
                            </div>
                            `)
                        })
                    }
                })
            });

            const calcular_prima_neta = function () {
                let prima = parseFloat($('#id_subtotal').val());
                let descuento = parseFloat($('#id_descuento').val());
                $('#id_prima_neta').val((prima - descuento).toFixed(2))
                    .trigger('change')
            };

            const calcular_total = function () {
                let prima_neta = parseFloat($('#id_prima_neta').val());
                let emision = parseFloat($('#id_emision').val());
                let iva = parseFloat($('#id_iva').val());
                let otros = parseFloat($('#id_otros').val());
                $('#id_total').val((prima_neta + emision + iva + otros).toFixed(2))
            };

            const calcular_comision = function () {
                let prima_neta = parseFloat($('#id_prima_neta').val());
                let per_comision = parseFloat($('#id_per_comision').val());
                $('#id_amount_comision').val(((prima_neta * per_comision) / 100).toFixed(2))
            };

            const calcular_tabla_pagos = function () {
                $.ajax("{% url 'cotizador:calcular_tabla_pagos' %}", {
                    method: "POST",
                    data: {
                        total: $('#id_total').val(), fecha: $('#id_fecha_pago').val(),
                        cuotas: $('#id_cuotas').val()
                    },
                    success: function (response) {
                        const pagos = $('#id_tabla_pagos tbody').empty();
                        $.each(response, function (i, o) {
                            pagos.append(`
                                    <tr>
                                        <td>
                                            <input type="text" name="" class="form-control" readonly value="${o.numero}">
                                        </td>
                                        <td>
                                            <input type="text" name="" class="form-control" readonly value="${o.fecha}">
                                        </td>
                                        <td>
                                            <input type="text" name="" class="form-control" value="${o.monto}">
                                        </td>
                                        <td>
                                            <input type="text" name="" class="form-control" readonly value="${o.estado}">
                                        </td>
                                    </tr>
                            `)
                        })
                    }
                })

            };

            $(document).on('change', '#id_subtotal', calcular_prima_neta);
            $(document).on('change', '#id_descuento', calcular_prima_neta);

            $(document).on('change', '#id_prima_neta', calcular_total);
            $(document).on('change', '#id_emision', calcular_total);
            $(document).on('change', '#id_iva', calcular_total);
            $(document).on('change', '#id_otros', calcular_total);

            $(document).on('change', '#id_prima_neta', calcular_comision);
            $(document).on('change', '#id_per_comision', calcular_comision);

            $(document).on('change', '#id_cuotas', calcular_tabla_pagos);
            $(document).on('change', '#id_fecha_pago', calcular_tabla_pagos);

            $(document).on('change', '#id_cesion_derecho', function () {
                if ($(this).is(':checked')) {
                    $('#col-cesionario').css('visibility', 'visible');
                } else {
                    $('#col-cesionario').css('visibility', 'hidden');
                }
            });

            const uploadFile = function (file) {
                const data = new FormData();
                data.append('file', file);
                data.append('new', 'new');
                data.append('app_label', 'cotizador');
                data.append('model', 'poliza');
                data.append('id', $('input[name="id"]').val());
                $.ajax("{% url 'trustseguros:documentos' %}", {
                    type: "POST",
                    data: data,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        console.log(response);
                        $('#drive-list').append(`
                            <tr>
                                <td> <a href="${ response.archivo.archivo }" target="_blank"><i class="fa fa-eye"></i></a> ${response.archivo.nombre}</td>
                                <td>${response.archivo.created_user.username}</td>
                                <td>${response.archivo.updated}</td>
                                <td style="text-align: center;">
                                    <button type="button" class="btn btn-danger btn-table-delete" data-id="{{ file.id }}">
                                        <span class="fa fa-trash"></span>
                                    </button>
                                </td>
                            </tr>
                        `);
                    }
                })
            };

            $(document).on('change', '#drive-files', function () {
                uploadFile(this.files[0]);
            });

        });

    </script>

    {% for script in media.js %}
        <script src="{% static script %}"></script>
    {% endfor %}
{% endblock %}