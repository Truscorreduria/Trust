<!DOCTYPE html>
<html lang="ES-NI">
<head>
    {% load static %}

    <title>{% block title %}{% endblock %}</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="{% static 'adminlte/plugins/fontawesome-free/css/all.min.css' %}">
    <link rel="stylesheet" href="{% static 'adminlte/css/adminlte.min.css' %}">
    <link rel="stylesheet" href="{% static 'adminlte/css/main.css' %}">
    {% block style %}

    {% endblock %}

    <script src="{% static 'adminlte/plugins/jquery/jquery.min.js' %}"></script>
    <script src="{% static 'adminlte/plugins/jquery-ui/jquery-ui.min.js' %}"></script>
</head>

<body class="hold-transition sidebar-mini layout-fixed">

<div class="wrapper">
    {% csrf_token %}
    <nav class="main-header navbar navbar-expand navbar-light">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item dropdown">
                <a class="nav-link" data-toggle="dropdown" href="#">
                    <i class="far fa-bell" style="color: white"></i>
                    <span class="badge badge-warning navbar-badge">0</span>
                </a>
                <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
                    <span class="dropdown-item dropdown-header">0 Notificaciones</span>
                    <a href="{% url 'cotizador:logout' %}" class="dropdown-item">
                        <i class="fas fa-power-off mr-2"></i> Cerrar sesión
                    </a>
                    <div class="dropdown-divider"></div>
                </div>
            </li>
        </ul>
    </nav>

    <aside class="main-sidebar sidebar-light-success elevation-4">
        <!-- Brand Logo -->
        <a href="{% url 'trustseguros:index' %}" class="brand-link">
            <img src="{% static '/trustseguros/lte/img/svg/logo.svg' %}" alt="Trust logo"
                 class="brand-image"
                 style="opacity: .8;">
            <span class="brand-text font-weight-bold">Trust-Seguros</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Sidebar user panel (optional) -->
            <div class="user-panel mt-3 pb-3 mb-3 d-flex">
                <div class="image">
                    <img src="{% static '/trustseguros/lte/img/user2-160x160.jpg' %}" class="img-circle elevation-2"
                         alt="User Image">
                </div>
                <div class="info">
                    <a href="{% url 'trustseguros:profile' %}" class="d-block">{{ user.username }}</a>
                </div>
            </div>
            <input type="hidden" name="path" value="{{ request.path }}">
            <!-- Sidebar Menu -->
            {% include 'adminlte/menu.html' %}
            <!-- /.sidebar-menu -->
        </div>
        <!-- /.sidebar -->
    </aside>

    <div class="content-wrapper">

        {% block content-header %}
            <div class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1 class="m-0 text-dark">{% block content-title %}{% endblock %}</h1>
                        </div><!-- /.col -->
                        <div class="col-sm-6">
                            {% block breadcrums %}
                                <ol class="breadcrumb float-sm-right">
                                    <li class="breadcrumb-item active">Inicio</li>
                                </ol>
                            {% endblock %}
                        </div><!-- /.col -->
                    </div><!-- /.row -->
                </div><!-- /.container-fluid -->
            </div>
        {% endblock %}

        <section class="content">
            <div class="container-fluid">
                {% block content %}
                    <div id="dashboard-polizas"></div>
                {% endblock %}
            </div>
        </section>

        {% block loader %}
            <div id="loader" style="width: 100%; left: 0;
            top: 30%; text-align: center; position: fixed;
            z-index: 999999; display: none">
                <img src="{% static 'cotizador/images/spinner.gif' %}" style="width: 400px">
            </div>
        {% endblock %}
    </div>

    <footer class="main-footer">
        <strong>Copyright &copy; 2019 <a href="https://www.trustcorreduria.com">Trust correduría de
            seguros</a>.</strong>
        <div class="float-right d-none d-sm-inline-block">
            <b>Versión</b> 1.0.0
        </div>
    </footer>

    <aside class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
    </aside>

</div>

<script>
    $.widget.bridge('uibutton', $.ui.button)
</script>

<script src="{% static 'adminlte/plugins/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
<script src="{% static 'adminlte/js/adminlte.js' %}"></script>
<script src="{% static 'adminlte/js/lte.main.js' %}"></script>
<script src="{% static 'adminlte/js/csfr.token.js' %}"></script>

{% block javascript %}
    <script src="{% static 'trustseguros/lte/plugins/d3/d3.min.js' %}"></script>
    <script src="{% static 'trustseguros/lte/plugins/d3-arrays/d3-array.min.js' %}"></script>
    <script src="{% static 'trustseguros/js/dashboard.poliza.js' %}"></script>


    {% comment %}<script type="text/javascript">
        function dashboard(id, fData) {
            var barColor = 'steelblue';

            function segColor(c) {
                return {Passenger: "#807dba", Delivery: "#e08214", Car: "#41ab5d"}[c];
            }

            // compute total for each state.
            fData.forEach(function (d) {
                d.total = d.freq.Passenger + d.freq.Delivery + d.freq.Car;
            });

            // function to handle histogram.
            function histoGram(fD) {
                var hG = {}, hGDim = {t: 60, r: 0, b: 30, l: 0};
                hGDim.w = 600 - hGDim.l - hGDim.r,
                    hGDim.h = 300 - hGDim.t - hGDim.b;

                //create svg for histogram.
                var hGsvg = d3.select(id).append("svg")
                    .attr("width", hGDim.w + hGDim.l + hGDim.r)
                    .attr("height", hGDim.h + hGDim.t + hGDim.b).append("g")
                    .attr("transform", "translate(" + hGDim.l + "," + hGDim.t + ")");

                // create function for x-axis mapping.
                var x = d3.scale.ordinal().rangeRoundBands([0, hGDim.w], 0.1)
                    .domain(fD.map(function (d) {
                        return d[0];
                    }));

                // Add x-axis to the histogram svg.
                hGsvg.append("g").attr("class", "x axis")
                    .attr("transform", "translate(0," + hGDim.h + ")")
                    .call(d3.svg.axis().scale(x).orient("bottom"))
                    .selectAll("text")
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", function (d) {
                        return "rotate(-65)"
                    });

                // Create function for y-axis map.
                var y = d3.scale.linear().range([hGDim.h, 0])
                    .domain([0, d3.max(fD, function (d) {
                        return d[1];
                    })]);

                // Create bars for histogram to contain rectangles and freq labels.
                var bars = hGsvg.selectAll(".bar").data(fD).enter()
                    .append("g").attr("class", "bar");

                //create the rectangles.
                bars.append("rect")
                    .attr("x", function (d) {
                        return x(d[0]);
                    })
                    .attr("y", function (d) {
                        return y(d[1]);
                    })
                    //.attr("width", 10)
                    .attr("width", x.rangeBand())
                    .attr("height", function (d) {
                        return hGDim.h - y(d[1]);
                    })
                    .attr('fill', barColor)
                    .on("mouseover", mouseover)// mouseover is defined bePassenger.
                    .on("mouseout", mouseout);// mouseout is defined bePassenger.

                //Create the frequency labels above the rectangles.
                bars.append("text").text(function (d) {
                    return d3.format(",")(d[1])
                })
                    .attr("x", function (d) {
                        return x(d[0]) + x.rangeBand() / 2;
                    })
                    .attr("y", function (d) {
                        return y(d[1]) - 5;
                    })
                    .attr("text-anchor", "middle");

                function mouseover(d) {  // utility function to be called on mouseover.
                    // filter for selected state.
                    var st = fData.filter(function (s) {
                            return s.State == d[0];
                        })[0],
                        nD = d3.keys(st.freq).map(function (s) {
                            return {type: s, freq: st.freq[s]};
                        });

                    // call update functions of pie-chart and legend.
                    pC.update(nD);
                    leg.update(nD);
                }

                function mouseout(d) {    // utility function to be called on mouseout.
                    // reset the pie-chart and legend.
                    pC.update(tF);
                    leg.update(tF);
                }

                // create function to update the bars. This will be used by pie-chart.
                hG.update = function (nD, color) {
                    // update the domain of the y-axis map to reflect change in frequencies.
                    y.domain([0, d3.max(nD, function (d) {
                        return d[1];
                    })]);

                    // Attach the new data to the bars.
                    var bars = hGsvg.selectAll(".bar").data(nD);

                    // transition the height and color of rectangles.
                    bars.select("rect").transition().duration(500)
                        .attr("y", function (d) {
                            return y(d[1]);
                        })
                        .attr("height", function (d) {
                            return hGDim.h - y(d[1]);
                        })
                        .attr("fill", color);

                    // transition the frequency labels location and change value.
                    bars.select("text").transition().duration(500)
                        .text(function (d) {
                            return d3.format(",")(d[1])
                        })
                        .attr("y", function (d) {
                            return y(d[1]) - 5;
                        });
                }
                return hG;
            }

            // function to handle pieChart.
            function pieChart(pD) {
                var pC = {}, pieDim = {w: 250, h: 250};
                pieDim.r = Math.min(pieDim.w, pieDim.h) / 2;

                // create svg for pie chart.
                var piesvg = d3.select(id).append("svg")
                    .attr("width", pieDim.w).attr("height", pieDim.h).append("g")
                    .attr("transform", "translate(" + pieDim.w / 2 + "," + pieDim.h / 2 + ")");

                // create function to draw the arcs of the pie slices.
                var arc = d3.svg.arc().outerRadius(pieDim.r - 10).innerRadius(0);

                // create a function to compute the pie slice angles.
                var pie = d3.layout.pie().sort(null).value(function (d) {
                    return d.freq;
                });

                // Draw the pie slices.
                piesvg.selectAll("path").data(pie(pD)).enter().append("path").attr("d", arc)
                    .each(function (d) {
                        this._current = d;
                    })
                    .style("fill", function (d) {
                        return segColor(d.data.type);
                    })
                    .on("mouseover", mouseover).on("mouseout", mouseout);

                // create function to update pie-chart. This will be used by histogram.
                pC.update = function (nD) {
                    piesvg.selectAll("path").data(pie(nD)).transition().duration(500)
                        .attrTween("d", arcTween);
                }

                // Utility function to be called on mouseover a pie slice.
                function mouseover(d) {
                    // call the update function of histogram with new data.
                    hG.update(fData.map(function (v) {
                        return [v.State, v.freq[d.data.type]];
                    }), segColor(d.data.type));
                }

                //Utility function to be called on mouseout a pie slice.
                function mouseout(d) {
                    // call the update function of histogram with all data.
                    hG.update(fData.map(function (v) {
                        return [v.State, v.total];
                    }), barColor);
                }

                // Animating the pie-slice requiring a custom function which specifies
                // how the intermediate paths should be drawn.
                function arcTween(a) {
                    var i = d3.interpolate(this._current, a);
                    this._current = i(0);
                    return function (t) {
                        return arc(i(t));
                    };
                }

                return pC;
            }

            // function to handle legend.
            function legend(lD) {
                var leg = {};

                // create table for legend.
                var legend = d3.select(id).append("table").attr('class', 'legend');

                // create one row per segment.
                var tr = legend.append("tbody").selectAll("tr").data(lD).enter().append("tr");

                // create the first column for each segment.
                tr.append("td").append("svg").attr("width", '16').attr("height", '16').append("rect")
                    .attr("width", '16').attr("height", '16')
                    .attr("fill", function (d) {
                        return segColor(d.type);
                    });

                // create the second column for each segment.
                tr.append("td").text(function (d) {
                    return d.type;
                });

                // create the third column for each segment.
                tr.append("td").attr("class", 'legendFreq')
                    .text(function (d) {
                        return d3.format(",")(d.freq);
                    });

                // create the fourth column for each segment.
                tr.append("td").attr("class", 'legendPerc')
                    .text(function (d) {
                        return getLegend(d, lD);
                    });

                // Utility function to be used to update the legend.
                leg.update = function (nD) {
                    // update the data attached to the row elements.
                    var l = legend.select("tbody").selectAll("tr").data(nD);

                    // update the frequencies.
                    l.select(".legendFreq").text(function (d) {
                        return d3.format(",")(d.freq);
                    });

                    // update the percentage column.
                    l.select(".legendPerc").text(function (d) {
                        return getLegend(d, nD);
                    });
                }

                function getLegend(d, aD) { // Utility function to compute percentage.
                    return d3.format("%")(d.freq / d3.sum(aD.map(function (v) {
                        return v.freq;
                    })));
                }

                return leg;
            }

            // calculate total frequency by segment for all state.
            var tF = ['Passenger', 'Delivery', 'Car'].map(function (d) {
                return {
                    type: d, freq: d3.sum(fData.map(function (t) {
                        return t.freq[d];
                    }))
                };
            });

            // calculate total frequency by state for all segment.
            var sF = fData.map(function (d) {
                return [d.State, d.total];
            });

            var hG = histoGram(sF), // create the histogram.
                pC = pieChart(tF), // create the pie-chart.
                leg = legend(tF);  // create the legend.
        }

        var freqData = [
            {State: '06-01', freq: {Passenger: 4786, Delivery: 1319, Car: 249}}
            , {State: '06-02', freq: {Passenger: 1101, Delivery: 412, Car: 674}}
            , {State: '06-03', freq: {Passenger: 932, Delivery: 2149, Car: 418}}
            , {State: '06-04', freq: {Passenger: 832, Delivery: 1152, Car: 1862}}
            , {State: '06-05', freq: {Passenger: 4481, Delivery: 3304, Car: 948}}
            , {State: '06-07', freq: {Passenger: 1619, Delivery: 167, Car: 1063}}
            , {State: 'IA', freq: {Passenger: 1819, Delivery: 247, Car: 1203}}
            , {State: 'IL', freq: {Passenger: 4498, Delivery: 3852, Car: 942}}
            , {State: 'IN', freq: {Passenger: 797, Delivery: 1849, Car: 1534}}
            , {State: 'AX', freq: {Passenger: 1101, Delivery: 412, Car: 674}}
            , {State: 'CD', freq: {Passenger: 932, Delivery: 2149, Car: 418}}
            , {State: 'SE', freq: {Passenger: 832, Delivery: 1152, Car: 1862}}
            , {State: 'FF', freq: {Passenger: 4481, Delivery: 3304, Car: 948}}
            , {State: 'GQ', freq: {Passenger: 1619, Delivery: 167, Car: 1063}}
            , {State: 'IE', freq: {Passenger: 1819, Delivery: 247, Car: 1203}}
            , {State: 'IH', freq: {Passenger: 4498, Delivery: 3852, Car: 942}}
            , {State: 'IM', freq: {Passenger: 797, Delivery: 1849, Car: 1534}}

            , {State: 'MZ', freq: {Passenger: 1101, Delivery: 412, Car: 674}}
            , {State: 'PT', freq: {Passenger: 932, Delivery: 2149, Car: 418}}
            , {State: 'VE', freq: {Passenger: 832, Delivery: 1152, Car: 1862}}
            , {State: 'OL', freq: {Passenger: 4481, Delivery: 3304, Car: 948}}
            , {State: 'RA', freq: {Passenger: 1619, Delivery: 167, Car: 1063}}
            , {State: 'YA', freq: {Passenger: 1819, Delivery: 247, Car: 1203}}
            , {State: 'BL', freq: {Passenger: 4498, Delivery: 3852, Car: 942}}
            , {State: 'ZN', freq: {Passenger: 797, Delivery: 1849, Car: 1534}}

            , {State: 'QZ', freq: {Passenger: 1101, Delivery: 412, Car: 674}}
            , {State: 'DT', freq: {Passenger: 932, Delivery: 2149, Car: 418}}
            , {State: 'TE', freq: {Passenger: 832, Delivery: 1152, Car: 1862}}

            , {State: 'KS', freq: {Passenger: 162, Delivery: 379, Car: 471}}
        ];

        dashboard('#dashboard', freqData);
    </script>{% endcomment %}
{% endblock %}
</body>
</html>
