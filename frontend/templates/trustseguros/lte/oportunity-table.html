{% extends 'adminlte/datatables.html' %}


{% block javascript %}
    {{ block.super }}

    <script type="text/javascript" defer>
        $(document).ready(function () {

            const ImportButton = $(`
                <button class="dt-button btn btn-trust" tabindex="0" aria-controls="receipt-table"
                type="button">
                    <span><i class="fa fa-file"></i> Importar datos</span>
                </button>
            `);

            ImportButton.on('click', function () {
                $.ajax("", {
                    method: "POST",
                    data: {},
                    success: function (response) {
                    }
                });
            });

            $('div.dt-buttons').append(ImportButton);

            $(document).on('change', '#id_ramo', function () {
                const _this = $(this);
                $.ajax("{% url 'ajax_getCollection' %}", {
                    method: 'POST',
                    data: {
                        app_label: 'backend', model: 'subramo',
                        filters: `{'ramo_id': '${_this.val()}'}`
                    },
                    success: function (response) {
                        const table = $('#id_sub_ramo').empty();
                        table.append(`<option value="">---------</option>`);
                        $.each(response, function (i, o) {
                            table.append(`<option value="${o.id}">${o.name}</option>`);
                        })
                    }
                })
            });

            $(document).on('change', '#id_sub_ramo', function () {
                const _this = $(this);
                $.ajax("{% url 'ajax_getCollection' %}", {
                    method: 'POST',
                    data: {
                        app_label: 'backend', model: 'campoadicional',
                        filters: `{'sub_ramo_id': '${_this.val()}'}`
                    },
                    success: function (response) {
                        const $fieldset = $('.extra_data_fieldset').empty();
                        console.log(response)
                        $.each(response, function (i, o) {
                            $fieldset.append(`
                                <div class="row">
                                    <div class="col">
                                        <div id="div_id_${o.name}" class="form-group">

                                            <label for="id_${o.name}" class="col-form-label ">
                                                ${o.label}
                                            </label>
                                            <div class="">
                                                <input type="text" name="${o.name}" class="textinput textInput form-control"
                                                id="id_${o.name}">
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            `)
                        })
                    }
                })
            });

            $(document).on('keyup', '#id_cedula', function () {
                $(this).autocomplete({
                    minLength: 2,
                    source: "{% url 'ajax_autocomplete' %}" + "?app_label=backend&model=prospect&column_name=cedula&column_value=cedula",
                    select: function (i, o) {
                        $('#id_primer_nombre').val(o.item.obj.primer_nombre).removeAttr('readonly');
                        $('#id_segundo_nombre').val(o.item.obj.segundo_nombre).removeAttr('readonly');
                        $('#id_apellido_paterno').val(o.item.obj.apellido_paterno).removeAttr('readonly');
                        $('#id_apellido_materno').val(o.item.obj.apellido_materno).removeAttr('readonly');
                        $('#id_departamento').val(o.item.obj.departamento).removeAttr('readonly');
                        $('#id_municipio').val(o.item.obj.municipio).removeAttr('readonly');
                        $('#id_estado_civil').val(o.item.obj.estado_civil).removeAttr('readonly');
                        $('#id_genero').val(o.item.obj.genero).removeAttr('readonly');
                        $('#id_telefono').val(o.item.obj.telefono).removeAttr('readonly');
                        $('#id_celular').val(o.item.obj.celular).removeAttr('readonly');
                        $('#id_domicilio').val(o.item.obj.domicilio).removeAttr('readonly');
                        $('#id_email_personal').val(o.item.obj.email_personal).removeAttr('readonly');
                        $('#id_cedula').attr('readonly', 'readonly');

                        $('.prospect-button-clear').css('display', 'initial');
                    }
                });

                if ($(this).val().length === 14) {
                    $('#id_primer_nombre').removeAttr('readonly');
                    $('#id_segundo_nombre').removeAttr('readonly');
                    $('#id_apellido_paterno').removeAttr('readonly');
                    $('#id_apellido_materno').removeAttr('readonly');
                    $('#id_departamento').removeAttr('readonly');
                    $('#id_municipio').removeAttr('readonly');
                    $('#id_estado_civil').removeAttr('readonly');
                    $('#id_genero').removeAttr('readonly');
                    $('#id_telefono').removeAttr('readonly');
                    $('#id_celular').removeAttr('readonly');
                    $('#id_domicilio').removeAttr('readonly');
                    $('#id_email_personal').removeAttr('readonly');

                    $('#id_cedula').attr('readonly', 'readonly');
                    $('.prospect-button-clear').css('display', 'initial');
                }
            });

            $(document).on('click', '.prospect-button-clear', function () {
                $('#id_primer_nombre').val('').attr('readonly', 'readonly');
                $('#id_segundo_nombre').val('').attr('readonly', 'readonly');
                $('#id_apellido_paterno').val('').attr('readonly', 'readonly');
                $('#id_apellido_materno').val('').attr('readonly', 'readonly');
                $('#id_departamento').val('').attr('readonly', 'readonly');
                $('#id_municipio').val('').attr('readonly', 'readonly');
                $('#id_estado_civil').val('').attr('readonly', 'readonly');
                $('#id_genero').val('').attr('readonly', 'readonly');
                $('#id_telefono').val('').attr('readonly', 'readonly');
                $('#id_celular').val('').attr('readonly', 'readonly');
                $('#id_domicilio').val('').attr('readonly', 'readonly');
                $('#id_email_personal').val('').attr('readonly', 'readonly');
                $('#id_cedula').val('').removeAttr('readonly', 'readonly');
                $(this).css('display', 'none');
            });

            $(document).on('change', '.aseguradora-check', function () {
                const form = document.getElementById('{{ opts.model_name }}-form');
                const data = new FormData(form);
                data.append('save', 'save');
                data.append('cotizar', 'cotizar');
                $.ajax('.', {
                    method: "post",
                    data: data,
                    processData: false,
                    contentType: false,
                    success: function (response, textStatus, xhr) {
                        process_response(response, textStatus, xhr)
                    },
                })
            })

        })
    </script>
{% endblock %}